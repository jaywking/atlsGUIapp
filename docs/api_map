# API Map - ATLS GUI App

Central reference for all FastAPI endpoints used in the ATLS GUI App.
Each endpoint connects a NiceGUI frontend action to a backend automation script or service.

---

## Current Endpoints

| Category | Endpoint | Method | Linked Script | Purpose | Response |
|-----------|-----------|--------|----------------|----------|-----------|
| Locations | `/api/locations/process` | POST | `scripts/process_new_locations.py` | Process "Ready" production locations, geocode via Google Maps, and sync results to Notion. | `{"status": "success", "message": "Locations processed"}` |
| Facilities | `/api/facilities/fetch` | POST | `scripts/fetch_medical_facilities.py` | Retrieve nearest medical facilities (ERs, urgent care) for each master location. | `{"status": "success", "message": "Facilities updated"}` |
| Jobs / Logs | `/api/jobs/logs` | GET | `app/services/logger.py` | Retrieve recent job execution logs for display in GUI. | `{"status": "success", "message": "Logs retrieved", "logs": [...]}` |
| Jobs / Maintenance | `/api/jobs/prune` | POST | `app/services/prune_logs.py` | Force log pruning/rotation using retention limits (drives the "Archive Now" button in Jobs UI). | `{"status": "success", "message": "Old log entries pruned", "stats": {...}}` |
| Settings | `/api/settings/test_connections` | POST | `app/services/config_tester.py` | Validate Notion and Google Maps credentials injected via `.env`. | `{"status": "success", "notion": "Connected", "maps": "Connected"}` |

---

## Planned Endpoints

| Category | Endpoint | Method | Linked Script | Description | Response |
|-----------|-----------|--------|----------------|-------------|-----------|
| Productions | `/api/productions/sync` | POST | (future) `scripts/sync_productions.py` | Sync production metadata and status from Notion Productions Master DB. | `{"status": "success", "message": "Productions synced"}` |
| Locations | `/api/locations/match` | POST | `scripts/match_location_master.py` | Match production-specific locations to master records using geocoded data. | `{"status": "success", "message": "Matches complete"}` |
| Facilities | `/api/facilities/backfill` | POST | (future) `scripts/backfill_facility_details.py` | Update missing facility contact details, hours, and coordinates. | `{"status": "success", "message": "Backfill complete"}` |

---

## Endpoint Conventions

- All endpoints return a JSON response with:
  ```json
  {
    "status": "success" | "error",
    "message": "Human-readable summary"
  }
  ```
- Long-running tasks may later include:
  ```json
  {
    "status": "success",
    "message": "Process started",
    "job_id": "UUID"
  }
  ```
- UI should use spinner and toast notifications for each API call (`ui.spinner`, `ui.notify()`).

---

## Implementation Rules

| Rule | Description |
|------|--------------|
| Router Structure | Each router file is in `/app/api/` and prefixed with its domain (e.g., `locations_api.py`). |
| Prefix | Use `/api/<category>` for router prefixes. Example: `router = APIRouter(prefix="/api/locations", tags=["locations"])` |
| Error Handling | Wrap all calls in `try/except` and return a structured JSON error message. |
| Async Support | When feasible, define routes as `async def` for non-blocking behavior. |
| Logging | Each route should write a short entry to the Jobs Log. |
| Testing | Endpoints can be manually tested via browser, Postman, or NiceGUI buttons. |

---

## Example Endpoint Template

```python
from fastapi import APIRouter
from scripts import process_new_locations

router = APIRouter(prefix="/api/locations", tags=["locations"])

@router.post("/process")
def process_locations():
    """Trigger the location processing workflow."""
    try:
        result = process_new_locations.main()
        return {"status": "success", "message": str(result)}
    except Exception as e:
        return {"status": "error", "message": str(e)}
```

---

## Integration Flow

| Step | Component | Description |
|------|-----------|-------------|
| 1 | NiceGUI Button | User clicks "Process Selected" or "Fetch Facilities". |
| 2 | Requests POST | UI sends a request to the relative FastAPI endpoint (`/api/...`). |
| 3 | FastAPI Router | Adapter calls corresponding script under `/scripts`. |
| 4 | Script Execution | Script runs logic (Notion, Maps, etc.) and returns a message. |
| 5 | Response | JSON result displayed as a toast message in the GUI. |
| 6 | Job Log | Status written to `/app/services/logger.py` for tracking. |

---

## Last Updated
2025-11-09